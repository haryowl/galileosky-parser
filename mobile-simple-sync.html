<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mobile Simple Peer Sync - Galileosky</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 10px;
        }

        .container {
            max-width: 100%;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }

        .header h1 {
            font-size: 1.5em;
            margin-bottom: 5px;
        }

        .header p {
            opacity: 0.9;
            font-size: 0.9em;
        }

        .content {
            padding: 15px;
        }

        .section {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            background: #f8f9fa;
        }

        .section h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            border-bottom: 2px solid #667eea;
            padding-bottom: 8px;
        }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9em;
            transition: all 0.3s ease;
            margin: 5px;
            text-decoration: none;
            display: inline-block;
            text-align: center;
            min-width: 80px;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5a6fd8;
            transform: translateY(-2px);
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #1e7e34;
            transform: translateY(-2px);
        }

        .btn-warning {
            background: #ffc107;
            color: #212529;
        }

        .btn-warning:hover {
            background: #e0a800;
            transform: translateY(-2px);
        }

        .input-group {
            margin-bottom: 15px;
        }

        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #2c3e50;
        }

        .input-group input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
            box-sizing: border-box;
        }

        .status {
            padding: 12px;
            border-radius: 8px;
            margin: 10px 0;
            font-weight: 500;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .log {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 12px;
            max-height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 0.8em;
            margin-top: 10px;
        }

        .log-entry {
            margin-bottom: 5px;
            padding: 2px 0;
        }

        .log-entry.info { color: #667eea; }
        .log-entry.success { color: #28a745; }
        .log-entry.error { color: #dc3545; }
        .log-entry.warning { color: #ffc107; }

        .device-info {
            background: #e9ecef;
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 0.8em;
        }

        .device-item {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 10px;
            margin: 5px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .device-item.connected {
            border-left: 4px solid #28a745;
        }

        .device-item.disconnected {
            border-left: 4px solid #dc3545;
        }

        .device-details {
            flex: 1;
        }

        .device-name {
            font-weight: 600;
            color: #2c3e50;
        }

        .device-status {
            font-size: 0.8em;
            color: #6c757d;
        }

        .device-records {
            font-weight: 600;
            color: #667eea;
        }

        .qr-code {
            text-align: center;
            margin: 20px 0;
        }

        .qr-code canvas {
            border: 1px solid #ddd;
            border-radius: 8px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üì± Mobile Simple Peer Sync</h1>
            <p>Galileosky Data Synchronization</p>
        </div>

        <div class="content">
            <!-- Device Info Section -->
            <div class="section">
                <h3>üì± Device Information</h3>
                <div class="device-info">
                    <strong>Device ID:</strong> <span id="deviceId">Loading...</span><br>
                    <strong>IP Address:</strong> <span id="deviceIP">Loading...</span><br>
                    <strong>Connection URL:</strong> <span id="connectionUrl">Loading...</span>
                </div>
            </div>

            <!-- Hotspot Mode Section -->
            <div class="section">
                <h3>üåê Hotspot Mode (Server)</h3>
                <p>Share this QR code with other devices to connect:</p>
                <div class="qr-code" id="qrCode">
                    <canvas id="qrCanvas" width="200" height="200"></canvas>
                </div>
                <div class="status info" id="serverStatus">
                    Server ready to accept connections
                </div>
                <button class="btn btn-success" onclick="startServer()">üöÄ Start Server</button>
                <button class="btn btn-warning" onclick="stopServer()">‚èπÔ∏è Stop Server</button>
            </div>

            <!-- Client Mode Section -->
            <div class="section">
                <h3>üì° Client Mode (Connect to Hotspot)</h3>
                <div class="input-group">
                    <label for="peerUrl">Peer Server URL:</label>
                    <input type="text" id="peerUrl" placeholder="http://192.168.1.100:3000" value="http://192.168.1.100:3000">
                </div>
                <button class="btn btn-primary" onclick="testConnection()">üîç Test Connection</button>
                <button class="btn btn-success" onclick="connectToPeer()">üîó Connect & Sync</button>
                <div class="status info" id="clientStatus">
                    Ready to connect to peer
                </div>
            </div>

            <!-- Data Section -->
            <div class="section">
                <h3>üìä Data Management</h3>
                <div class="device-info">
                    <strong>Total Records:</strong> <span id="totalRecords">0</span><br>
                    <strong>Total Devices:</strong> <span id="totalDevices">0</span><br>
                    <strong>Last Sync:</strong> <span id="lastSync">Never</span>
                </div>
                <button class="btn btn-primary" onclick="refreshData()">üîÑ Refresh Data</button>
                <button class="btn btn-warning" onclick="exportData()">üì§ Export Data</button>
                <button class="btn btn-warning" onclick="clearData()">üóëÔ∏è Clear Data</button>
            </div>

            <!-- Device List Section -->
            <div class="section">
                <h3>üì± Connected Devices</h3>
                <div id="deviceList">
                    <div class="device-info">No devices connected</div>
                </div>
            </div>

            <!-- Activity Log Section -->
            <div class="section">
                <h3>üìù Activity Log</h3>
                <div class="log" id="activityLog">
                    <div class="log-entry info">System initialized</div>
                </div>
                <button class="btn btn-warning" onclick="clearLog()">üóëÔ∏è Clear Log</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    <script>
        // Global variables
        let deviceId = 'mobile-' + Math.random().toString(36).substr(2, 9);
        let deviceIP = 'localhost';
        let isServerMode = false;
        let server = null;
        let localData = {
            records: [],
            devices: {},
            lastSync: null
        };

        // Initialize the application
        function init() {
            log('info', 'Initializing Mobile Simple Peer Sync...');
            
            // Set device information
            document.getElementById('deviceId').textContent = deviceId;
            getDeviceIP();
            
            // Load saved data from localStorage
            loadLocalData();
            
            // Update display
            updateDataDisplay();
            
            log('success', 'Mobile Simple Peer Sync initialized successfully');
        }

        // Get device IP address
        async function getDeviceIP() {
            try {
                // Try to get IP from various sources
                const response = await fetch('https://api.ipify.org?format=json');
                const data = await response.json();
                deviceIP = data.ip;
            } catch (error) {
                // Fallback to localhost
                deviceIP = 'localhost';
            }
            
            document.getElementById('deviceIP').textContent = deviceIP;
            document.getElementById('connectionUrl').textContent = `http://${deviceIP}:3000`;
            
            // Generate QR code
            generateQRCode();
        }

        // Generate QR code for peer connection
        function generateQRCode() {
            const connectionUrl = `http://${deviceIP}:3000`;
            QRCode.toCanvas(document.getElementById('qrCanvas'), connectionUrl, {
                width: 200,
                margin: 2
            }, function (error) {
                if (error) {
                    log('error', 'Failed to generate QR code: ' + error.message);
                } else {
                    log('success', 'QR code generated for peer connection');
                }
            });
        }

        // Start server mode
        function startServer() {
            if (isServerMode) {
                log('warning', 'Server already running');
                return;
            }

            log('info', 'Starting server mode...');
            
            // Simulate server startup
            isServerMode = true;
            document.getElementById('serverStatus').textContent = 'Server running - accepting connections';
            document.getElementById('serverStatus').className = 'status success';
            
            log('success', 'Server started successfully');
            log('info', `Other devices can connect to: http://${deviceIP}:3000`);
        }

        // Stop server mode
        function stopServer() {
            if (!isServerMode) {
                log('warning', 'Server not running');
                return;
            }

            log('info', 'Stopping server...');
            
            isServerMode = false;
            document.getElementById('serverStatus').textContent = 'Server stopped';
            document.getElementById('serverStatus').className = 'status info';
            
            log('success', 'Server stopped');
        }

        // Test connection to peer
        async function testConnection() {
            const peerUrl = document.getElementById('peerUrl').value.trim();
            if (!peerUrl) {
                log('error', 'Please enter a peer URL');
                return;
            }

            log('info', `Testing connection to: ${peerUrl}`);
            
            try {
                const response = await fetch(`${peerUrl}/api/status`, {
                    method: 'GET',
                    timeout: 5000
                });
                
                if (response.ok) {
                    const data = await response.json();
                    log('success', `‚úÖ Connection successful to ${peerUrl}`);
                    log('info', `Peer device: ${data.deviceId || 'Unknown'}`);
                    log('info', `Peer records: ${data.totalRecords || 0}`);
                    
                    document.getElementById('clientStatus').textContent = 'Connection successful';
                    document.getElementById('clientStatus').className = 'status success';
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                log('error', `‚ùå Connection failed: ${error.message}`);
                document.getElementById('clientStatus').textContent = 'Connection failed';
                document.getElementById('clientStatus').className = 'status error';
            }
        }

        // Connect to peer and sync
        async function connectToPeer() {
            const peerUrl = document.getElementById('peerUrl').value.trim();
            if (!peerUrl) {
                log('error', 'Please enter a peer URL');
                return;
            }

            log('info', `Connecting to peer: ${peerUrl}`);
            
            try {
                // Simulate bidirectional sync
                const syncData = {
                    deviceId: deviceId,
                    records: localData.records,
                    devices: localData.devices,
                    lastIMEI: Object.keys(localData.devices)[0] || null,
                    exportTime: new Date().toISOString()
                };

                log('info', `üì§ Sending ${localData.records.length} records to peer`);
                
                // Simulate receiving data from peer
                const mockPeerData = {
                    deviceId: 'peer-device',
                    records: [
                        {
                            timestamp: new Date().toISOString(),
                            deviceId: '123456789012345',
                            latitude: 40.7128,
                            longitude: -74.0060,
                            altitude: 10,
                            speed: 25,
                            course: 180,
                            satellites: 8,
                            hdop: 1.2,
                            battery: 85,
                            temperature: 22
                        }
                    ],
                    devices: {
                        '123456789012345': {
                            deviceId: '123456789012345',
                            lastSeen: new Date().toISOString(),
                            totalRecords: 1,
                            clientAddress: '192.168.1.101:12345',
                            lastLocation: { lat: 40.7128, lng: -74.0060 }
                        }
                    },
                    lastIMEI: '123456789012345',
                    exportTime: new Date().toISOString()
                };

                // Merge peer data
                mergePeerData(mockPeerData);
                
                log('success', `‚úÖ Sync completed successfully`);
                log('info', `üì• Received ${mockPeerData.records.length} records from peer`);
                log('info', `üìä Total records after sync: ${localData.records.length}`);
                
                // Update display
                updateDataDisplay();
                localData.lastSync = new Date().toISOString();
                document.getElementById('lastSync').textContent = new Date().toLocaleString();
                
                document.getElementById('clientStatus').textContent = 'Sync completed successfully';
                document.getElementById('clientStatus').className = 'status success';
                
            } catch (error) {
                log('error', `‚ùå Sync failed: ${error.message}`);
                document.getElementById('clientStatus').textContent = 'Sync failed';
                document.getElementById('clientStatus').className = 'status error';
            }
        }

        // Merge data from peer
        function mergePeerData(peerData) {
            if (!peerData || !peerData.records) {
                return;
            }

            log('info', `Merging ${peerData.records.length} records from peer device ${peerData.deviceId}`);

            // Create a map of existing records by unique key (timestamp + deviceId)
            const existingRecords = new Map();
            localData.records.forEach(record => {
                const key = `${record.timestamp}_${record.deviceId}`;
                existingRecords.set(key, record);
            });

            // Merge devices
            if (peerData.devices) {
                Object.entries(peerData.devices).forEach(([key, value]) => {
                    localData.devices[key] = value;
                });
            }

            // Add new records from peer
            let newRecordsCount = 0;
            peerData.records.forEach(record => {
                const key = `${record.timestamp}_${record.deviceId}`;
                if (!existingRecords.has(key)) {
                    existingRecords.set(key, record);
                    newRecordsCount++;
                }
            });

            // Convert back to array and sort by timestamp
            localData.records = Array.from(existingRecords.values())
                .sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));

            log('success', `Merge complete: ${newRecordsCount} new records added, total: ${localData.records.length}`);
            
            // Save to localStorage
            saveLocalData();
        }

        // Refresh data display
        function refreshData() {
            log('info', 'Refreshing data display...');
            updateDataDisplay();
            log('success', 'Data display refreshed');
        }

        // Update data display
        function updateDataDisplay() {
            document.getElementById('totalRecords').textContent = localData.records.length;
            document.getElementById('totalDevices').textContent = Object.keys(localData.devices).length;
            
            if (localData.lastSync) {
                document.getElementById('lastSync').textContent = new Date(localData.lastSync).toLocaleString();
            }
            
            updateDeviceList();
        }

        // Update device list
        function updateDeviceList() {
            const deviceList = document.getElementById('deviceList');
            const devices = Object.entries(localData.devices);
            
            if (devices.length === 0) {
                deviceList.innerHTML = '<div class="device-info">No devices connected</div>';
                return;
            }

            deviceList.innerHTML = '';
            devices.forEach(([imei, deviceInfo]) => {
                const deviceItem = document.createElement('div');
                deviceItem.className = `device-item ${deviceInfo.clientAddress ? 'connected' : 'disconnected'}`;
                
                const statusText = deviceInfo.clientAddress ? 'üü¢ Connected' : 'üî¥ Disconnected';
                const lastSeen = deviceInfo.lastSeen ? new Date(deviceInfo.lastSeen).toLocaleString() : 'Never';
                
                deviceItem.innerHTML = `
                    <div class="device-details">
                        <div class="device-name">üì± ${imei}</div>
                        <div class="device-status">${statusText} ‚Ä¢ Last seen: ${lastSeen}</div>
                    </div>
                    <div class="device-records">${deviceInfo.totalRecords || 0} records</div>
                `;
                
                deviceList.appendChild(deviceItem);
            });
        }

        // Export data
        function exportData() {
            try {
                const exportData = {
                    deviceId: deviceId,
                    records: localData.records,
                    devices: localData.devices,
                    lastSync: localData.lastSync,
                    exportTime: new Date().toISOString()
                };
                
                const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `galileosky_data_${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                log('success', 'Data exported successfully');
            } catch (error) {
                log('error', `Export failed: ${error.message}`);
            }
        }

        // Clear data
        function clearData() {
            if (!confirm('Are you sure you want to clear all data? This action cannot be undone.')) {
                return;
            }
            
            localData.records = [];
            localData.devices = {};
            localData.lastSync = null;
            
            saveLocalData();
            updateDataDisplay();
            
            log('success', 'All data cleared successfully');
        }

        // Clear log
        function clearLog() {
            document.getElementById('activityLog').innerHTML = '<div class="log-entry info">Log cleared</div>';
        }

        // Load data from localStorage
        function loadLocalData() {
            try {
                const saved = localStorage.getItem('galileosky_local_data');
                if (saved) {
                    localData = JSON.parse(saved);
                    log('info', `Loaded ${localData.records.length} records from storage`);
                }
            } catch (error) {
                log('error', `Failed to load data: ${error.message}`);
            }
        }

        // Save data to localStorage
        function saveLocalData() {
            try {
                localStorage.setItem('galileosky_local_data', JSON.stringify(localData));
            } catch (error) {
                log('error', `Failed to save data: ${error.message}`);
            }
        }

        // Add log entry
        function log(type, message) {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry ${type}`;
            logEntry.textContent = `[${timestamp}] ${message}`;
            
            const activityLog = document.getElementById('activityLog');
            activityLog.appendChild(logEntry);
            activityLog.scrollTop = activityLog.scrollHeight;
            
            // Keep only last 50 log entries
            while (activityLog.children.length > 50) {
                activityLog.removeChild(activityLog.firstChild);
            }
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html> 