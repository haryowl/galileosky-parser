<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Galileosky Parser - Real-time Tracking</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 1.8em;
            margin-bottom: 8px;
            font-weight: 300;
        }

        .header p {
            opacity: 0.9;
            font-size: 0.9em;
        }

        .status-bar {
            background: #f8f9fa;
            padding: 10px 20px;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
            font-size: 0.85em;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .status-dot.connected {
            background: #28a745;
        }

        .status-dot.disconnected {
            background: #dc3545;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            font-size: 0.8em;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }

        .btn-primary {
            background: #007bff;
            color: white;
        }

        .btn-primary:hover {
            background: #0056b3;
            transform: translateY(-2px);
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #1e7e34;
            transform: translateY(-2px);
        }

        .btn-warning {
            background: #ffc107;
            color: #212529;
        }

        .btn-warning:hover {
            background: #e0a800;
            transform: translateY(-2px);
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            padding: 20px;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
                gap: 15px;
                padding: 15px;
            }
            
            .header h1 {
                font-size: 1.5em;
            }
            
            .header p {
                font-size: 0.8em;
            }
            
            .status-bar {
                padding: 8px 15px;
                gap: 8px;
            }
            
            .status-indicator {
                font-size: 0.8em;
            }
            
            .btn {
                padding: 5px 10px;
                font-size: 0.75em;
            }
            
            .panel {
                padding: 12px;
            }
            
            .panel h3 {
                font-size: 1em;
                margin-bottom: 12px;
            }
            
            .data-item {
                padding: 8px;
            }
            
            .data-label {
                font-size: 0.7em;
            }
            
            .data-value {
                font-size: 0.9em;
            }
            
            .stat-value {
                font-size: 1.2em;
            }
            
            .stat-label {
                font-size: 0.7em;
            }
            
            .parameters-grid {
                grid-template-columns: 1fr;
                gap: 8px;
            }
            
            .parameter-item {
                padding: 8px;
            }
            
            .parameter-name {
                font-size: 0.75em;
            }
            
            .parameter-value {
                font-size: 0.85em;
            }
            
            .parameter-description {
                font-size: 0.65em;
            }
            
            #map {
                height: 250px;
            }
        }

        .panel {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            border: 1px solid #e9ecef;
        }

        .panel h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.1em;
            border-bottom: 2px solid #007bff;
            padding-bottom: 8px;
        }

        .data-grid {
            display: grid;
            gap: 10px;
        }

        .data-item {
            background: white;
            padding: 10px;
            border-radius: 6px;
            border-left: 3px solid #007bff;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .data-label {
            font-weight: 600;
            color: #495057;
            margin-bottom: 3px;
            font-size: 0.75em;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .data-value {
            font-size: 0.95em;
            color: #2c3e50;
            font-weight: 500;
        }

        .data-value.coordinates {
            font-family: 'Courier New', monospace;
            background: #f8f9fa;
            padding: 3px 8px;
            border-radius: 3px;
            border: 1px solid #dee2e6;
            font-size: 0.85em;
        }

        .map-container {
            grid-column: 1 / -1;
            background: white;
            border-radius: 8px;
            padding: 15px;
            border: 1px solid #e9ecef;
        }

        .map-container h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.1em;
            border-bottom: 2px solid #007bff;
            padding-bottom: 8px;
        }

        #map {
            width: 100%;
            height: 300px;
            border-radius: 6px;
            border: 1px solid #dee2e6;
        }

        .parameters-panel {
            grid-column: 1 / -1;
            background: white;
            border-radius: 8px;
            padding: 15px;
            border: 1px solid #e9ecef;
            max-height: 400px;
            overflow-y: auto;
        }

        .parameters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 10px;
        }

        .parameter-item {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 6px;
            border-left: 3px solid #28a745;
        }

        .parameter-name {
            font-weight: 600;
            color: #495057;
            margin-bottom: 3px;
            font-size: 0.8em;
        }

        .parameter-value {
            font-size: 0.9em;
            color: #2c3e50;
            font-weight: 500;
            word-break: break-all;
        }

        .parameter-description {
            font-size: 0.7em;
            color: #6c757d;
            margin-top: 3px;
            font-style: italic;
        }

        .no-data {
            text-align: center;
            color: #6c757d;
            font-style: italic;
            padding: 20px;
            font-size: 0.9em;
        }

        .loading {
            text-align: center;
            color: #007bff;
            padding: 15px;
            font-size: 0.9em;
        }

        .spinner {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #007bff;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            margin: 0 auto 8px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .stats {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }

        .stat-item {
            background: white;
            padding: 10px;
            border-radius: 6px;
            text-align: center;
            min-width: 100px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .stat-value {
            font-size: 1.4em;
            font-weight: bold;
            color: #007bff;
        }

        .stat-label {
            font-size: 0.75em;
            color: #6c757d;
            margin-top: 3px;
        }

        /* LED Status Indicators */
        .led-container {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 5px;
        }

        .led-item {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.75em;
        }

        .led {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            border: 1px solid #ccc;
            box-shadow: 0 0 5px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
        }

        .led.on {
            background: #28a745;
            box-shadow: 0 0 8px rgba(40, 167, 69, 0.6);
        }

        .led.off {
            background: #dc3545;
            box-shadow: 0 0 5px rgba(220, 53, 69, 0.3);
        }

        .led-label {
            font-size: 0.7em;
            color: #495057;
            font-weight: 500;
        }

        /* Download Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 20px;
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #dee2e6;
        }

        .modal-title {
            font-size: 1.2em;
            font-weight: 600;
            color: #2c3e50;
        }

        .close {
            color: #aaa;
            font-size: 1.5em;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: #000;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #495057;
            font-size: 0.9em;
        }

        .form-control {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 0.9em;
        }

        .form-control:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 2px rgba(0,123,255,0.25);
        }

        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #545b62;
        }

        /* Foldable Sections */
        .foldable-section {
            border: 1px solid #e9ecef;
            border-radius: 8px;
            margin-bottom: 15px;
            overflow: hidden;
        }

        .foldable-header {
            background: #f8f9fa;
            padding: 12px 15px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #e9ecef;
            transition: background-color 0.3s ease;
        }

        .foldable-header:hover {
            background: #e9ecef;
        }

        .foldable-title {
            font-size: 1.1em;
            font-weight: 600;
            color: #2c3e50;
            margin: 0;
        }

        .foldable-icon {
            font-size: 1.2em;
            transition: transform 0.3s ease;
            color: #6c757d;
        }

        .foldable-icon.collapsed {
            transform: rotate(-90deg);
        }

        .foldable-content {
            background: white;
            padding: 15px;
            max-height: 1000px;
            overflow: hidden;
            transition: max-height 0.3s ease, padding 0.3s ease;
        }

        .foldable-content.collapsed {
            max-height: 0;
            padding-top: 0;
            padding-bottom: 0;
        }

        /* Map container specific styling */
        .map-container.foldable-section {
            grid-column: 1 / -1;
        }

        .map-container .foldable-content {
            padding: 15px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🚀 Galileosky Parser</h1>
            <p>Real-time IoT Device Tracking & Data Visualization</p>
        </div>

        <div class="status-bar">
            <div class="status-indicator">
                <div id="statusDot" class="status-dot disconnected"></div>
                <span id="statusText">Disconnected</span>
            </div>
            <div class="controls">
                <button class="btn btn-primary" onclick="openDownloadModal()">📥 Download Data</button>
                <button class="btn btn-warning" onclick="clearData()">🗑️ Clear Data</button>
                <a href="/api/health" class="btn btn-success" target="_blank">🔧 API Health</a>
            </div>
        </div>

        <div class="main-content">
            <!-- Live Statistics -->
            <div class="foldable-section">
                <div class="foldable-header" onclick="toggleSection('stats')">
                    <h3 class="foldable-title">📊 Live Statistics</h3>
                    <span class="foldable-icon" id="stats-icon">▼</span>
                </div>
                <div class="foldable-content" id="stats-content">
                    <div class="stats">
                        <div class="stat-item">
                            <div id="packetCount" class="stat-value">0</div>
                            <div class="stat-label">Packets Received</div>
                        </div>
                        <div class="stat-item">
                            <div id="deviceCount" class="stat-value">0</div>
                            <div class="stat-label">Devices</div>
                        </div>
                        <div class="stat-item">
                            <div id="lastUpdate" class="stat-value">--</div>
                            <div class="stat-label">Last Update</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Current Location -->
            <div class="foldable-section">
                <div class="foldable-header" onclick="toggleSection('location')">
                    <h3 class="foldable-title">📍 Current Location</h3>
                    <span class="foldable-icon" id="location-icon">▼</span>
                </div>
                <div class="foldable-content" id="location-content">
                    <div class="data-grid">
                        <div class="data-item">
                            <div class="data-label">Device ID</div>
                            <div id="deviceId" class="data-value">No data</div>
                        </div>
                        <div class="data-item">
                            <div class="data-label">Coordinates</div>
                            <div id="coordinates" class="data-value coordinates">No GPS data</div>
                        </div>
                        <div class="data-item">
                            <div class="data-label">Speed</div>
                            <div id="speed" class="data-value">No data</div>
                        </div>
                        <div class="data-item">
                            <div class="data-label">Direction</div>
                            <div id="direction" class="data-value">No data</div>
                        </div>
                        <div class="data-item">
                            <div class="data-label">Height</div>
                            <div id="height" class="data-value">No data</div>
                        </div>
                        <div class="data-item">
                            <div class="data-label">Satellites</div>
                            <div id="satellites" class="data-value">No data</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Device Status -->
            <div class="foldable-section">
                <div class="foldable-header" onclick="toggleSection('status')">
                    <h3 class="foldable-title">🔋 Device Status</h3>
                    <span class="foldable-icon" id="status-icon">▼</span>
                </div>
                <div class="foldable-content" id="status-content">
                    <div class="data-grid">
                        <div class="data-item">
                            <div class="data-label">Supply Voltage</div>
                            <div id="supplyVoltage" class="data-value">No data</div>
                        </div>
                        <div class="data-item">
                            <div class="data-label">Battery Voltage</div>
                            <div id="batteryVoltage" class="data-value">No data</div>
                        </div>
                        <div class="data-item">
                            <div class="data-label">Temperature</div>
                            <div id="temperature" class="data-value">No data</div>
                        </div>
                        <div class="data-item">
                            <div class="data-label">Status</div>
                            <div id="status" class="data-value">No data</div>
                        </div>
                        <div class="data-item">
                            <div class="data-label">Packet Type</div>
                            <div id="packetType" class="data-value">No data</div>
                        </div>
                        <div class="data-item">
                            <div class="data-label">IMEI</div>
                            <div id="imei" class="data-value">No data</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- All Parameters -->
            <div class="foldable-section">
                <div class="foldable-header" onclick="toggleSection('parameters')">
                    <h3 class="foldable-title">📋 All Parameters</h3>
                    <span class="foldable-icon" id="parameters-icon">▼</span>
                </div>
                <div class="foldable-content" id="parameters-content">
                    <div id="parametersContainer">
                        <div class="no-data">No parameters received yet</div>
                    </div>
                </div>
            </div>

            <!-- Live Map -->
            <div class="map-container foldable-section">
                <div class="foldable-header" onclick="toggleSection('map')">
                    <h3 class="foldable-title">🗺️ Live Map</h3>
                    <span class="foldable-icon" id="map-icon">▼</span>
                </div>
                <div class="foldable-content" id="map-content">
                    <div id="map">
                        <div class="loading">
                            <div class="spinner"></div>
                            Loading map...
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Download Modal -->
    <div id="downloadModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="modal-title">📥 Download Data</span>
                <span class="close" onclick="closeDownloadModal()">&times;</span>
            </div>
            <div class="form-group">
                <label class="form-label">Time Period:</label>
                <select id="timePeriod" class="form-control">
                    <option value="all">All Data</option>
                    <option value="1h">Last 1 Hour</option>
                    <option value="6h">Last 6 Hours</option>
                    <option value="24h">Last 24 Hours</option>
                    <option value="7d">Last 7 Days</option>
                    <option value="30d">Last 30 Days</option>
                    <option value="custom">Custom Range</option>
                </select>
            </div>
            <div id="customRange" class="form-group" style="display: none;">
                <label class="form-label">Start Date & Time:</label>
                <input type="datetime-local" id="startDate" class="form-control">
                <label class="form-label">End Date & Time:</label>
                <input type="datetime-local" id="endDate" class="form-control">
            </div>
            <div class="form-group">
                <label class="form-label">Format:</label>
                <select id="downloadFormat" class="form-control">
                    <option value="json">JSON</option>
                    <option value="csv">CSV</option>
                    <option value="xlsx">Excel (XLSX)</option>
                </select>
            </div>
            <div class="btn-group">
                <button class="btn btn-primary" onclick="downloadData()">📥 Download</button>
                <button class="btn btn-secondary" onclick="closeDownloadModal()">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        let map;
        let currentMarker;
        let lastData = null;
        let devices = new Set();
        let packetCount = 0;

        // Initialize the application
        function init() {
            loadMap();
            startPolling();
            initializeFoldableSections();
        }

        // Load OpenStreetMap
        function loadMap() {
            const mapDiv = document.getElementById('map');
            mapDiv.innerHTML = `
                <iframe 
                    width="100%" 
                    height="400" 
                    frameborder="0" 
                    scrolling="no" 
                    marginheight="0" 
                    marginwidth="0" 
                    src="https://www.openstreetmap.org/export/embed.html?bbox=-180,-90,180,90&layer=mapnik&marker=0,0"
                    style="border: 1px solid #ccc; border-radius: 8px;">
                </iframe>
            `;
        }

        // Start polling for data
        function startPolling() {
            pollData();
            setInterval(pollData, 2000); // Poll every 2 seconds
        }

        // Poll data from the API
        async function pollData() {
            try {
                const response = await fetch('/api/data/latest');
                if (response.ok) {
                    const data = await response.json();
                    updateUI(data);
                    updateStatus(true);
                } else {
                    updateStatus(false);
                }
            } catch (error) {
                console.error('Error polling data:', error);
                updateStatus(false);
            }
        }

        // Update the UI with new data
        function updateUI(data) {
            if (!data || !data.length) return;

            // Get the most recent packet with actual data (not just IMEI)
            let latestPacket = data[0]; // Start with the first (most recent) packet
            
            // Look for a packet with actual coordinates or other meaningful data
            for (let i = 0; i < data.length; i++) {
                const packet = data[i];
                if (packet.latitude !== null && packet.longitude !== null) {
                    latestPacket = packet;
                    break;
                }
            }
            
            lastData = latestPacket;
            
            // Debug logging
            console.log('Frontend received data:', {
                packetCount: data.length,
                selectedPacketIndex: data.indexOf(latestPacket),
                latestPacket: {
                    deviceId: latestPacket.deviceId,
                    imei: latestPacket.imei,
                    latitude: latestPacket.latitude,
                    longitude: latestPacket.longitude,
                    speed: latestPacket.speed,
                    direction: latestPacket.direction,
                    height: latestPacket.height,
                    satellites: latestPacket.satellites,
                    supplyVoltage: latestPacket.supplyVoltage,
                    batteryVoltage: latestPacket.batteryVoltage,
                    temperature: latestPacket.temperature,
                    status: latestPacket.status,
                    hasTags: !!latestPacket.tags,
                    tagCount: latestPacket.tags ? Object.keys(latestPacket.tags).length : 0
                }
            });
            
            // Update statistics
            packetCount = data.length;
            devices.clear();
            data.forEach(packet => {
                if (packet.deviceId) devices.add(packet.deviceId);
            });

            document.getElementById('packetCount').textContent = packetCount;
            document.getElementById('deviceCount').textContent = devices.size;
            document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();

            // Update location data
            if (latestPacket.latitude && latestPacket.longitude) {
                document.getElementById('coordinates').textContent = 
                    `${latestPacket.latitude.toFixed(6)}, ${latestPacket.longitude.toFixed(6)}`;
                updateMap(latestPacket.latitude, latestPacket.longitude);
            }

            // Update device info
            document.getElementById('deviceId').textContent = latestPacket.deviceId || 'Unknown';
            document.getElementById('speed').textContent = latestPacket.speed ? `${latestPacket.speed.toFixed(1)} km/h` : 'No data';
            document.getElementById('direction').textContent = latestPacket.direction ? `${latestPacket.direction}°` : 'No data';
            document.getElementById('height').textContent = latestPacket.height ? `${latestPacket.height}m` : 'No data';
            document.getElementById('satellites').textContent = latestPacket.satellites || 'No data';

            // Update device status
            document.getElementById('supplyVoltage').textContent = latestPacket.supplyVoltage ? `${latestPacket.supplyVoltage}mV` : 'No data';
            document.getElementById('batteryVoltage').textContent = latestPacket.batteryVoltage ? `${latestPacket.batteryVoltage}mV` : 'No data';
            document.getElementById('temperature').textContent = latestPacket.temperature ? `${latestPacket.temperature}°C` : 'No data';
            document.getElementById('status').textContent = latestPacket.status || 'No data';
            document.getElementById('packetType').textContent = latestPacket.packetType || 'No data';
            document.getElementById('imei').textContent = latestPacket.imei || 'No data';

            // Update all parameters
            updateParameters(latestPacket);
        }

        // Update parameters display
        function updateParameters(packet) {
            const container = document.getElementById('parametersContainer');
            
            if (!packet.tags || Object.keys(packet.tags).length === 0) {
                container.innerHTML = '<div class="no-data">No parameters received yet</div>';
                return;
            }

            const parametersHtml = Object.entries(packet.tags).map(([tagHex, tagData]) => {
                let displayValue = tagData.value;
                let ledHtml = '';
                
                // Format different types of values
                if (typeof tagData.value === 'object') {
                    if (tagData.type === 'coordinates') {
                        displayValue = `${tagData.value.latitude.toFixed(6)}, ${tagData.value.longitude.toFixed(6)} (${tagData.value.satellites} sats)`;
                    } else if (tagData.type === 'speedDirection') {
                        displayValue = `${tagData.value.speed.toFixed(1)} km/h, ${tagData.value.direction}°`;
                    } else if (tagData.type === 'outputs') {
                        displayValue = `Raw: ${tagData.value.raw} (${tagData.value.binary})`;
                        // Create LED indicators for outputs
                        ledHtml = '<div class="led-container">';
                        for (let i = 0; i < 16; i++) {
                            const isOn = tagData.value.states[`output${i}`];
                            ledHtml += `
                                <div class="led-item">
                                    <div class="led ${isOn ? 'on' : 'off'}"></div>
                                    <span class="led-label">O${i}</span>
                                </div>
                            `;
                        }
                        ledHtml += '</div>';
                    } else if (tagData.type === 'inputs') {
                        displayValue = `Raw: ${tagData.value.raw} (${tagData.value.binary})`;
                        // Create LED indicators for inputs
                        ledHtml = '<div class="led-container">';
                        for (let i = 0; i < 16; i++) {
                            const isOn = tagData.value.states[`input${i}`];
                            ledHtml += `
                                <div class="led-item">
                                    <div class="led ${isOn ? 'on' : 'off'}"></div>
                                    <span class="led-label">I${i}</span>
                                </div>
                            `;
                        }
                        ledHtml += '</div>';
                    } else {
                        displayValue = JSON.stringify(tagData.value);
                    }
                } else if (tagData.type === 'datetime') {
                    displayValue = new Date(tagData.value).toLocaleString();
                } else if (tagData.type === 'uint16' && tagData.description.includes('Voltage')) {
                    displayValue = `${tagData.value} mV`;
                } else if (tagData.type === 'int8' && tagData.description.includes('Temperature')) {
                    displayValue = `${tagData.value}°C`;
                } else if (tagData.type === 'uint16' && tagData.description.includes('Height')) {
                    displayValue = `${tagData.value}m`;
                }

                return `
                    <div class="parameter-item">
                        <div class="parameter-name">${tagData.description} (${tagHex})</div>
                        <div class="parameter-value">${displayValue}</div>
                        ${ledHtml}
                        <div class="parameter-description">${tagData.type}</div>
                    </div>
                `;
            }).join('');

            container.innerHTML = `
                <div class="parameters-grid">
                    ${parametersHtml}
                </div>
            `;
        }

        // Update map with new coordinates
        function updateMap(lat, lon) {
            const mapUrl = `https://www.openstreetmap.org/export/embed.html?bbox=${lon-0.01},${lat-0.01},${lon+0.01},${lat+0.01}&layer=mapnik&marker=${lat},${lon}`;
            const mapFrame = document.querySelector('#map iframe');
            if (mapFrame) {
                mapFrame.src = mapUrl;
            }
        }

        // Update connection status
        function updateStatus(connected) {
            const statusDot = document.getElementById('statusDot');
            const statusText = document.getElementById('statusText');
            
            if (connected) {
                statusDot.className = 'status-dot connected';
                statusText.textContent = 'Connected';
            } else {
                statusDot.className = 'status-dot disconnected';
                statusText.textContent = 'Disconnected';
            }
        }

        // Modal functions
        function openDownloadModal() {
            document.getElementById('downloadModal').style.display = 'block';
            // Set default end date to now
            const now = new Date();
            const nowStr = now.toISOString().slice(0, 16);
            document.getElementById('endDate').value = nowStr;
            
            // Set default start date to 1 hour ago
            const oneHourAgo = new Date(now.getTime() - 60 * 60 * 1000);
            const oneHourAgoStr = oneHourAgo.toISOString().slice(0, 16);
            document.getElementById('startDate').value = oneHourAgoStr;
        }

        function closeDownloadModal() {
            document.getElementById('downloadModal').style.display = 'none';
        }

        // Handle time period change
        function handleTimePeriodChange() {
            const timePeriod = document.getElementById('timePeriod').value;
            const customRange = document.getElementById('customRange');
            
            if (timePeriod === 'custom') {
                customRange.style.display = 'block';
            } else {
                customRange.style.display = 'none';
            }
        }

        // Download data with options
        async function downloadData() {
            try {
                const timePeriod = document.getElementById('timePeriod').value;
                const format = document.getElementById('downloadFormat').value;
                let startDate, endDate;

                // Calculate date range based on selection
                if (timePeriod === 'custom') {
                    startDate = new Date(document.getElementById('startDate').value);
                    endDate = new Date(document.getElementById('endDate').value);
                } else {
                    endDate = new Date();
                    switch (timePeriod) {
                        case '1h':
                            startDate = new Date(endDate.getTime() - 60 * 60 * 1000);
                            break;
                        case '6h':
                            startDate = new Date(endDate.getTime() - 6 * 60 * 60 * 1000);
                            break;
                        case '24h':
                            startDate = new Date(endDate.getTime() - 24 * 60 * 60 * 1000);
                            break;
                        case '7d':
                            startDate = new Date(endDate.getTime() - 7 * 24 * 60 * 60 * 1000);
                            break;
                        case '30d':
                            startDate = new Date(endDate.getTime() - 30 * 24 * 60 * 60 * 1000);
                            break;
                        default: // 'all'
                            startDate = new Date(0);
                            break;
                    }
                }

                // Get data from API
                const response = await fetch('/api/data/latest?limit=10000');
                if (!response.ok) {
                    throw new Error('Failed to fetch data');
                }
                
                let data = await response.json();
                
                // Filter data by date range
                data = data.filter(packet => {
                    const packetDate = new Date(packet.timestamp);
                    return packetDate >= startDate && packetDate <= endDate;
                });

                // Format data based on selected format
                let downloadData, filename, mimeType;
                
                switch (format) {
                    case 'json':
                        downloadData = JSON.stringify(data, null, 2);
                        filename = `galileosky_data_${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.json`;
                        mimeType = 'application/json';
                        break;
                        
                    case 'csv':
                        downloadData = convertToCSV(data);
                        filename = `galileosky_data_${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.csv`;
                        mimeType = 'text/csv';
                        break;
                        
                    case 'xlsx':
                        // For XLSX, we'll create a simple CSV-like structure that Excel can open
                        downloadData = convertToCSV(data);
                        filename = `galileosky_data_${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.xlsx`;
                        mimeType = 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet';
                        break;
                }

                // Download the file
                const blob = new Blob([downloadData], { type: mimeType });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                closeDownloadModal();
                alert(`Data downloaded successfully! (${data.length} records)`);
                
            } catch (error) {
                console.error('Error downloading data:', error);
                alert('Error downloading data. Please try again.');
            }
        }

        // Convert data to CSV format
        function convertToCSV(data) {
            if (!data || data.length === 0) return '';
            
            // Get all possible fields from all records
            const allFields = new Set();
            data.forEach(record => {
                Object.keys(record).forEach(key => {
                    if (key !== 'tags' && key !== 'rawData') {
                        allFields.add(key);
                    }
                });
            });
            
            const fields = Array.from(allFields).sort();
            const csvRows = [];
            
            // Add header
            csvRows.push(fields.join(','));
            
            // Add data rows
            data.forEach(record => {
                const row = fields.map(field => {
                    const value = record[field];
                    if (value === null || value === undefined) {
                        return '';
                    } else if (typeof value === 'string' && value.includes(',')) {
                        return `"${value}"`;
                    } else {
                        return value;
                    }
                });
                csvRows.push(row.join(','));
            });
            
            return csvRows.join('\n');
        }

        // Clear stored data
        async function clearData() {
            if (confirm('Are you sure you want to clear all stored data?')) {
                try {
                    const response = await fetch('/api/clear', { method: 'POST' });
                    if (response.ok) {
                        // Reset UI
                        document.getElementById('packetCount').textContent = '0';
                        document.getElementById('deviceCount').textContent = '0';
                        document.getElementById('lastUpdate').textContent = '--';
                        document.getElementById('parametersContainer').innerHTML = '<div class="no-data">No parameters received yet</div>';
                        
                        // Reset location data
                        document.getElementById('coordinates').textContent = 'No GPS data';
                        document.getElementById('deviceId').textContent = 'No data';
                        document.getElementById('speed').textContent = 'No data';
                        document.getElementById('direction').textContent = 'No data';
                        document.getElementById('height').textContent = 'No data';
                        document.getElementById('satellites').textContent = 'No data';
                        
                        // Reset device status
                        document.getElementById('supplyVoltage').textContent = 'No data';
                        document.getElementById('batteryVoltage').textContent = 'No data';
                        document.getElementById('temperature').textContent = 'No data';
                        document.getElementById('status').textContent = 'No data';
                        document.getElementById('packetType').textContent = 'No data';
                        document.getElementById('imei').textContent = 'No data';
                        
                        alert('Data cleared successfully!');
                    }
                } catch (error) {
                    console.error('Error clearing data:', error);
                    alert('Error clearing data. Please try again.');
                }
            }
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', init);
        
        // Add event listener for time period change
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('timePeriod').addEventListener('change', handleTimePeriodChange);
        });

        // Toggle foldable sections
        function toggleSection(sectionId) {
            const content = document.getElementById(sectionId + '-content');
            const icon = document.getElementById(sectionId + '-icon');
            
            if (content.classList.contains('collapsed')) {
                // Expand section
                content.classList.remove('collapsed');
                icon.classList.remove('collapsed');
                icon.textContent = '▼';
            } else {
                // Collapse section
                content.classList.add('collapsed');
                icon.classList.add('collapsed');
                icon.textContent = '▶';
            }
            
            // Save the state
            saveFoldableState();
        }

        // Initialize foldable sections state (optional: remember user preferences)
        function initializeFoldableSections() {
            // You can add localStorage to remember user preferences
            const savedState = localStorage.getItem('foldableSections');
            if (savedState) {
                const state = JSON.parse(savedState);
                Object.keys(state).forEach(sectionId => {
                    if (!state[sectionId]) { // If section was collapsed
                        toggleSection(sectionId);
                    }
                });
            }
        }

        // Save foldable sections state
        function saveFoldableState() {
            const sections = ['stats', 'location', 'status', 'parameters', 'map'];
            const state = {};
            sections.forEach(sectionId => {
                const content = document.getElementById(sectionId + '-content');
                state[sectionId] = !content.classList.contains('collapsed');
            });
            localStorage.setItem('foldableSections', JSON.stringify(state));
        }
    </script>
</body>
</html> 