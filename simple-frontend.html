<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Galileosky Parser - Real-time Tracking</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 300;
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1em;
        }

        .status-bar {
            background: #f8f9fa;
            padding: 15px 30px;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 500;
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .status-dot.connected {
            background: #28a745;
        }

        .status-dot.disconnected {
            background: #dc3545;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }

        .btn-primary {
            background: #007bff;
            color: white;
        }

        .btn-primary:hover {
            background: #0056b3;
            transform: translateY(-2px);
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #1e7e34;
            transform: translateY(-2px);
        }

        .btn-warning {
            background: #ffc107;
            color: #212529;
        }

        .btn-warning:hover {
            background: #e0a800;
            transform: translateY(-2px);
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            padding: 30px;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }

        .panel {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 25px;
            border: 1px solid #e9ecef;
        }

        .panel h3 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.4em;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
        }

        .data-grid {
            display: grid;
            gap: 15px;
        }

        .data-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #007bff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .data-label {
            font-weight: 600;
            color: #495057;
            margin-bottom: 5px;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .data-value {
            font-size: 1.2em;
            color: #2c3e50;
            font-weight: 500;
        }

        .data-value.coordinates {
            font-family: 'Courier New', monospace;
            background: #f8f9fa;
            padding: 5px 10px;
            border-radius: 4px;
            border: 1px solid #dee2e6;
        }

        .map-container {
            grid-column: 1 / -1;
            background: white;
            border-radius: 10px;
            padding: 25px;
            border: 1px solid #e9ecef;
        }

        .map-container h3 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.4em;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
        }

        #map {
            width: 100%;
            height: 400px;
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }

        .parameters-panel {
            grid-column: 1 / -1;
            background: white;
            border-radius: 10px;
            padding: 25px;
            border: 1px solid #e9ecef;
            max-height: 500px;
            overflow-y: auto;
        }

        .parameters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
        }

        .parameter-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #28a745;
        }

        .parameter-name {
            font-weight: 600;
            color: #495057;
            margin-bottom: 5px;
            font-size: 0.9em;
        }

        .parameter-value {
            font-size: 1.1em;
            color: #2c3e50;
            font-weight: 500;
            word-break: break-all;
        }

        .parameter-description {
            font-size: 0.8em;
            color: #6c757d;
            margin-top: 5px;
            font-style: italic;
        }

        .no-data {
            text-align: center;
            color: #6c757d;
            font-style: italic;
            padding: 40px;
        }

        .loading {
            text-align: center;
            color: #007bff;
            padding: 20px;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #007bff;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .stats {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .stat-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            min-width: 120px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .stat-value {
            font-size: 1.8em;
            font-weight: bold;
            color: #007bff;
        }

        .stat-label {
            font-size: 0.9em;
            color: #6c757d;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöÄ Galileosky Parser</h1>
            <p>Real-time IoT Device Tracking & Data Visualization</p>
        </div>

        <div class="status-bar">
            <div class="status-indicator">
                <div id="statusDot" class="status-dot disconnected"></div>
                <span id="statusText">Disconnected</span>
            </div>
            <div class="controls">
                <button class="btn btn-primary" onclick="downloadData()">üì• Download Data</button>
                <button class="btn btn-warning" onclick="clearData()">üóëÔ∏è Clear Data</button>
                <a href="/api/health" class="btn btn-success" target="_blank">üîß API Health</a>
            </div>
        </div>

        <div class="main-content">
            <div class="panel">
                <h3>üìä Live Statistics</h3>
                <div class="stats">
                    <div class="stat-item">
                        <div id="packetCount" class="stat-value">0</div>
                        <div class="stat-label">Packets Received</div>
                    </div>
                    <div class="stat-item">
                        <div id="deviceCount" class="stat-value">0</div>
                        <div class="stat-label">Devices</div>
                    </div>
                    <div class="stat-item">
                        <div id="lastUpdate" class="stat-value">--</div>
                        <div class="stat-label">Last Update</div>
                    </div>
                </div>
            </div>

            <div class="panel">
                <h3>üìç Current Location</h3>
                <div class="data-grid">
                    <div class="data-item">
                        <div class="data-label">Device ID</div>
                        <div id="deviceId" class="data-value">No data</div>
                    </div>
                    <div class="data-item">
                        <div class="data-label">Coordinates</div>
                        <div id="coordinates" class="data-value coordinates">No GPS data</div>
                    </div>
                    <div class="data-item">
                        <div class="data-label">Speed</div>
                        <div id="speed" class="data-value">No data</div>
                    </div>
                    <div class="data-item">
                        <div class="data-label">Direction</div>
                        <div id="direction" class="data-value">No data</div>
                    </div>
                    <div class="data-item">
                        <div class="data-label">Height</div>
                        <div id="height" class="data-value">No data</div>
                    </div>
                    <div class="data-item">
                        <div class="data-label">Satellites</div>
                        <div id="satellites" class="data-value">No data</div>
                    </div>
                </div>
            </div>

            <div class="panel">
                <h3>üîã Device Status</h3>
                <div class="data-grid">
                    <div class="data-item">
                        <div class="data-label">Supply Voltage</div>
                        <div id="supplyVoltage" class="data-value">No data</div>
                    </div>
                    <div class="data-item">
                        <div class="data-label">Battery Voltage</div>
                        <div id="batteryVoltage" class="data-value">No data</div>
                    </div>
                    <div class="data-item">
                        <div class="data-label">Temperature</div>
                        <div id="temperature" class="data-value">No data</div>
                    </div>
                    <div class="data-item">
                        <div class="data-label">Status</div>
                        <div id="status" class="data-value">No data</div>
                    </div>
                    <div class="data-item">
                        <div class="data-label">Packet Type</div>
                        <div id="packetType" class="data-value">No data</div>
                    </div>
                    <div class="data-item">
                        <div class="data-label">IMEI</div>
                        <div id="imei" class="data-value">No data</div>
                    </div>
                </div>
            </div>

            <div class="parameters-panel">
                <h3>üìã All Parameters</h3>
                <div id="parametersContainer">
                    <div class="no-data">No parameters received yet</div>
                </div>
            </div>

            <div class="map-container">
                <h3>üó∫Ô∏è Live Map</h3>
                <div id="map">
                    <div class="loading">
                        <div class="spinner"></div>
                        Loading map...
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let map;
        let currentMarker;
        let lastData = null;
        let devices = new Set();
        let packetCount = 0;

        // Initialize the application
        function init() {
            loadMap();
            startPolling();
        }

        // Load OpenStreetMap
        function loadMap() {
            const mapDiv = document.getElementById('map');
            mapDiv.innerHTML = `
                <iframe 
                    width="100%" 
                    height="400" 
                    frameborder="0" 
                    scrolling="no" 
                    marginheight="0" 
                    marginwidth="0" 
                    src="https://www.openstreetmap.org/export/embed.html?bbox=-180,-90,180,90&layer=mapnik&marker=0,0"
                    style="border: 1px solid #ccc; border-radius: 8px;">
                </iframe>
            `;
        }

        // Start polling for data
        function startPolling() {
            pollData();
            setInterval(pollData, 2000); // Poll every 2 seconds
        }

        // Poll data from the API
        async function pollData() {
            try {
                const response = await fetch('/api/data');
                if (response.ok) {
                    const data = await response.json();
                    updateUI(data);
                    updateStatus(true);
                } else {
                    updateStatus(false);
                }
            } catch (error) {
                console.error('Error polling data:', error);
                updateStatus(false);
            }
        }

        // Update the UI with new data
        function updateUI(data) {
            if (!data || !data.length) return;

            const latestPacket = data[data.length - 1];
            lastData = latestPacket;
            
            // Update statistics
            packetCount = data.length;
            devices.clear();
            data.forEach(packet => {
                if (packet.deviceId) devices.add(packet.deviceId);
            });

            document.getElementById('packetCount').textContent = packetCount;
            document.getElementById('deviceCount').textContent = devices.size;
            document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();

            // Update location data
            if (latestPacket.latitude && latestPacket.longitude) {
                document.getElementById('coordinates').textContent = 
                    `${latestPacket.latitude.toFixed(6)}, ${latestPacket.longitude.toFixed(6)}`;
                updateMap(latestPacket.latitude, latestPacket.longitude);
            }

            // Update device info
            document.getElementById('deviceId').textContent = latestPacket.deviceId || 'Unknown';
            document.getElementById('speed').textContent = latestPacket.speed ? `${latestPacket.speed.toFixed(1)} km/h` : 'No data';
            document.getElementById('direction').textContent = latestPacket.direction ? `${latestPacket.direction}¬∞` : 'No data';
            document.getElementById('height').textContent = latestPacket.height ? `${latestPacket.height}m` : 'No data';
            document.getElementById('satellites').textContent = latestPacket.satellites || 'No data';

            // Update device status
            document.getElementById('supplyVoltage').textContent = latestPacket.supplyVoltage ? `${latestPacket.supplyVoltage}mV` : 'No data';
            document.getElementById('batteryVoltage').textContent = latestPacket.batteryVoltage ? `${latestPacket.batteryVoltage}mV` : 'No data';
            document.getElementById('temperature').textContent = latestPacket.temperature ? `${latestPacket.temperature}¬∞C` : 'No data';
            document.getElementById('status').textContent = latestPacket.status || 'No data';
            document.getElementById('packetType').textContent = latestPacket.packetType || 'No data';
            document.getElementById('imei').textContent = latestPacket.imei || 'No data';

            // Update all parameters
            updateParameters(latestPacket);
        }

        // Update parameters display
        function updateParameters(packet) {
            const container = document.getElementById('parametersContainer');
            
            if (!packet.tags || Object.keys(packet.tags).length === 0) {
                container.innerHTML = '<div class="no-data">No parameters received yet</div>';
                return;
            }

            const parametersHtml = Object.entries(packet.tags).map(([tagHex, tagData]) => {
                let displayValue = tagData.value;
                
                // Format different types of values
                if (typeof tagData.value === 'object') {
                    if (tagData.type === 'coordinates') {
                        displayValue = `${tagData.value.latitude.toFixed(6)}, ${tagData.value.longitude.toFixed(6)} (${tagData.value.satellites} sats)`;
                    } else if (tagData.type === 'speedDirection') {
                        displayValue = `${tagData.value.speed.toFixed(1)} km/h, ${tagData.value.direction}¬∞`;
                    } else {
                        displayValue = JSON.stringify(tagData.value);
                    }
                } else if (tagData.type === 'datetime') {
                    displayValue = new Date(tagData.value).toLocaleString();
                } else if (tagData.type === 'uint16' && tagData.name.includes('Voltage')) {
                    displayValue = `${tagData.value} mV`;
                } else if (tagData.type === 'int8' && tagData.name.includes('Temperature')) {
                    displayValue = `${tagData.value}¬∞C`;
                } else if (tagData.type === 'int16' && tagData.name.includes('Height')) {
                    displayValue = `${tagData.value}m`;
                }

                return `
                    <div class="parameter-item">
                        <div class="parameter-name">${tagData.name} (${tagHex})</div>
                        <div class="parameter-value">${displayValue}</div>
                        <div class="parameter-description">${tagData.description}</div>
                    </div>
                `;
            }).join('');

            container.innerHTML = `
                <div class="parameters-grid">
                    ${parametersHtml}
                </div>
            `;
        }

        // Update map with new coordinates
        function updateMap(lat, lon) {
            const mapUrl = `https://www.openstreetmap.org/export/embed.html?bbox=${lon-0.01},${lat-0.01},${lon+0.01},${lat+0.01}&layer=mapnik&marker=${lat},${lon}`;
            const mapFrame = document.querySelector('#map iframe');
            if (mapFrame) {
                mapFrame.src = mapUrl;
            }
        }

        // Update connection status
        function updateStatus(connected) {
            const statusDot = document.getElementById('statusDot');
            const statusText = document.getElementById('statusText');
            
            if (connected) {
                statusDot.className = 'status-dot connected';
                statusText.textContent = 'Connected';
            } else {
                statusDot.className = 'status-dot disconnected';
                statusText.textContent = 'Disconnected';
            }
        }

        // Download data as JSON
        async function downloadData() {
            try {
                const response = await fetch('/api/data');
                if (response.ok) {
                    const data = await response.json();
                    
                    // Create a comprehensive download with all parameters
                    const downloadData = data.map(packet => ({
                        timestamp: packet.timestamp,
                        deviceId: packet.deviceId,
                        imei: packet.imei,
                        packetType: packet.packetType,
                        header: packet.header,
                        hasUnsentData: packet.hasUnsentData,
                        length: packet.length,
                        rawData: packet.rawData,
                        // Location data
                        latitude: packet.latitude,
                        longitude: packet.longitude,
                        speed: packet.speed,
                        direction: packet.direction,
                        height: packet.height,
                        satellites: packet.satellites,
                        // Device status
                        supplyVoltage: packet.supplyVoltage,
                        batteryVoltage: packet.batteryVoltage,
                        temperature: packet.temperature,
                        status: packet.status,
                        // All parsed parameters
                        parameters: packet.parameters,
                        tags: packet.tags
                    }));

                    const blob = new Blob([JSON.stringify(downloadData, null, 2)], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `galileosky_data_${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                }
            } catch (error) {
                console.error('Error downloading data:', error);
                alert('Error downloading data. Please try again.');
            }
        }

        // Clear stored data
        async function clearData() {
            if (confirm('Are you sure you want to clear all stored data?')) {
                try {
                    const response = await fetch('/api/clear', { method: 'POST' });
                    if (response.ok) {
                        // Reset UI
                        document.getElementById('packetCount').textContent = '0';
                        document.getElementById('deviceCount').textContent = '0';
                        document.getElementById('lastUpdate').textContent = '--';
                        document.getElementById('parametersContainer').innerHTML = '<div class="no-data">No parameters received yet</div>';
                        
                        // Reset location data
                        document.getElementById('coordinates').textContent = 'No GPS data';
                        document.getElementById('deviceId').textContent = 'No data';
                        document.getElementById('speed').textContent = 'No data';
                        document.getElementById('direction').textContent = 'No data';
                        document.getElementById('height').textContent = 'No data';
                        document.getElementById('satellites').textContent = 'No data';
                        
                        // Reset device status
                        document.getElementById('supplyVoltage').textContent = 'No data';
                        document.getElementById('batteryVoltage').textContent = 'No data';
                        document.getElementById('temperature').textContent = 'No data';
                        document.getElementById('status').textContent = 'No data';
                        document.getElementById('packetType').textContent = 'No data';
                        document.getElementById('imei').textContent = 'No data';
                        
                        alert('Data cleared successfully!');
                    }
                } catch (error) {
                    console.error('Error clearing data:', error);
                    alert('Error clearing data. Please try again.');
                }
            }
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html> 